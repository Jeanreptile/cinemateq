var CINEGRAPH=function(a){a.animateNodeScale=function(a,k,g,h){k=void 0!==k?k:8;g=void 0!==g?g:200;h=void 0!==h?h:940;(new TWEEN.Tween(a.scale)).to({x:k,y:k,z:k},g).delay(h).easing(TWEEN.Easing.Linear.None).start()};a.animateNodePosition=function(a,k,g){void 0!==k&&(new TWEEN.Tween(a.position)).to({x:k.x,y:k.y,z:k.z},g).easing(TWEEN.Easing.Elastic.InOut).start()};a.animateNodeAndLine=function(a,k,g,h){(new TWEEN.Tween(a.position)).to({x:g.x,y:g.y,z:g.z},h).easing(TWEEN.Easing.Elastic.InOut).onUpdate(function(){k.geometry.vertices[0].set(a.position.x,
a.position.y,a.position.z);k.geometry.verticesNeedUpdate=!0}).start()};a.animateLine=function(a,k,g){(new TWEEN.Tween(a.geometry.vertices[1])).to({x:k.x,y:k.y,z:k.z},1E3).easing(TWEEN.Easing.Linear.None).onUpdate(function(){a.geometry.verticesNeedUpdate=!0}).start();(new TWEEN.Tween(a.geometry.vertices[0])).to({x:g.x,y:g.y,z:g.z},1E3).easing(TWEEN.Easing.Linear.None).onUpdate(function(){a.geometry.verticesNeedUpdate=!0}).start()};return a}(CINEGRAPH||{});CINEGRAPH=function(a){a.cameraControls=null;a.camera=null;a.initCamera=function(){$("#graph").css("height","100%");a.viewWidth=$("#graph").width();a.viewHeight=$("#graph").height();a.camera=new THREE.PerspectiveCamera(70,a.viewWidth/a.viewHeight,1,1E3);a.camera.position.set(0,0,33);a.cameraControls=new THREE.TrackballControls(a.camera,document.getElementById("graph"));a.cameraControls.rotateSpeed=2;a.cameraControls.zoomSpeed=1.2;a.cameraControls.panSpeed=.8;a.cameraControls.noZoom=!1;a.cameraControls.noPan=
!1;a.cameraControls.staticMoving=!0;a.cameraControls.dynamicDampingFactor=.3;a.cameraControls.keys=[65,83,68]};a.cameraLookAtPosition=function(m){var k=(new THREE.Vector3).copy(a.camera.position).sub(m).setLength(33).add(m);(new TWEEN.Tween(a.camera.position)).to({x:k.x,y:k.y,z:k.z},1E3).easing(TWEEN.Easing.Quartic.InOut).start();(new TWEEN.Tween(a.cameraControls.target)).to({x:m.x,y:m.y,z:m.z},1E3).easing(TWEEN.Easing.Quartic.InOut).start()};a.cameraLookAtNode=function(m){m=a.findNode(m);void 0!=
m&&a.cameraLookAtPosition(m.position)};a.getSpriteRadius=function(m,k){var g=new THREE.Vector3,h=new THREE.Vector3(0,0,-1),p=new THREE.Vector3,f=new THREE.Vector3;g.copy(m).sub(a.camera.position);h.applyQuaternion(a.camera.quaternion);0==g.angleTo(h)&&(g.x+=1E-5);p.crossVectors(g,h).setLength(4);f.copy(m).add(p);return a.toScreenPosition(f).distanceTo(a.toScreenPosition(m))*k/8};a.toScreenPosition=function(m){var k=new THREE.Vector3;k.copy(m);m=.5*a.viewWidth;var g=.5*a.viewHeight;k.project(a.camera);
k.x=k.x*m+m;k.y=-(k.y*g)+g;return new THREE.Vector3(k.x,k.y,0)};return a}(CINEGRAPH||{});CINEGRAPH=function(a){a.scene=null;a.linesScene=null;a.viewWidth=0;a.viewHeight=0;a.currentNode=null;a.options={enablePathfinding:!1,maxDepth:1};a.relationships={ACTED_IN:{limit:4,color:"#319ef1",active:!0},DIRECTED:{limit:1,color:"#8e44ad",active:!0},PRODUCED:{limit:1,color:"#27ae60",active:!0},COMPOSED_MUSIC:{limit:1,color:"#00d6ce",active:!0},DIRECTED_PHOTOGRAPHY:{limit:1,color:"#fc6e51",active:!1},WROTE:{limit:1,color:"#f1c40f",active:!0},EDITED:{limit:1,color:"#e33244",active:!1},DESIGNED_PRODUCTION:{limit:1,
color:"#ac92ec",active:!1},DESIGNED_COSTUMES:{limit:1,color:"#ec87c0",active:!1}};a.types={Movie:{color:"#ffa226"}};a.initScene=function(){a.scene=new THREE.Scene;a.linesScene=new THREE.Scene;a.linesScene.add(a.camera)};a.init=function(m){$http=m;$("#graph").css("opacity",0);a.initCamera();a.initScene();a.initRender();a.initTexture();a.initInput();a.animate();$("#graph").animate({opacity:1},4E3)};a.destroy=function(){a.destroyRender();a.destroyInput()};return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(f){if(void 0!==a.types[f.label]&&void 0!==a.types[f.label].color)return a.types[f.label].color;var d=Object.keys(f._relationships)[0],c;for(c in f._relationships)f._relationships[c].count>f._relationships[d].count&&(d=c);return a.relationships[d].color}function k(f){var d={},c;for(c in a.relationships)d[c]={skip:0,limit:a.relationships[c].limit,active:a.relationships[c].active,count:void 0!==f[c]?f[c]:0};return d}function g(f,d,c){f._depth=d+1;c.push(f.id);for(var b=
f._neighbours.length-1;0<=b;b--){var e=a.findNode(f._neighbours[b]);void 0!==e?(-1===c.indexOf(e.node.id)||d+1<e.node._depth)&&g(e.node,f._depth,c):f._neighbours.splice(b,1)}}function h(f,d,c){var b=new THREE.Geometry;b.vertices.push(f.clone(),f.clone());c?(f=a.relationships[d].color,c=a.types.Movie.color):(f=a.types.Movie.color,c=a.relationships[d].color);b.colors.push(new THREE.Color(f));b.colors.push(new THREE.Color(c));b=new THREE.Line(b,new THREE.LineBasicMaterial({linewidth:1,vertexColors:!0}));
b._type=d;return b}function p(f){f=a.findNode(f);if(void 0!=f){var d=new THREE.MeshBasicMaterial({color:new THREE.Color(void 0!=f.mainJob?a.colors[f.mainJob]:a.orangeColor),transparent:!0,opacity:.5,depthWrite:!1}),d=new THREE.Mesh(new THREE.CircleGeometry(.65,32),d);d.scale.set(.9,.9,.9);d.tween=(new TWEEN.Tween(d.scale)).to({x:1,y:1,z:1},1300).easing(TWEEN.Easing.Quartic.InOut).onComplete(function(){}).yoyo(!0).repeat(Infinity);d.tween.start();d.IsSuggestionCircle=!0;d.gradientRemoveDisable=!0;
f.IsSuggested=!0;f.add(d)}}a.addNode=function(f,d){return new Promise(function(c,b){void 0===a.findNode(f)?$http.get("/api/common/"+f).success(function(b){var n=b.node;n._relationships=k(b.relationships);n._color=m(n);n._depth=0;n._neighbours=[];b=a.getNodeSprite(n);b.scale.set(0,0,0);d=void 0!==d?d:a.getNewPosition();b.position.set(d.x,d.y,d.z);a.scene.add(b);a.animateNodeScale(b);c(f)}):b("Node not found")})};a.addRelatedNodes=function(f,d){return new Promise(function(c,b){var e=a.findNode(f);void 0!==
e?(void 0===d&&(d=e.node._relationships),$http.get("/api/common/related/"+f+"/"+JSON.stringify(d)).success(function(b){for(var d=a.getOccupiedPositions(),l=0;l<b.length;l++)(function(l){setTimeout(function(){if(void 0===a.findNode(b[l].node.id)){var c=b[l].node;c.label=b[l].label;for(var g=b[l].relationships,p={},t=0;t<g.length;t++)p[g[t][0]]=g[t][1];c._relationships=k(p);c._color=m(c);c._depth=e._depth+1;c._neighbours=[e.node.id];e.node._neighbours.push(c.id);g=a.getNodeSprite(c);g.scale.set(0,0,
0);position=a.getNextPosition(d,e.position);d.push(position);g.position.set(e.position.x,e.position.y,e.position.z);a.scene.add(g);c=h(e.position,b[l].type,c.name);c.endNodeId=g.node.id;c.startNodeId=f;a.linesScene.add(c);a.animateNodeScale(g);a.animateNodeAndLine(g,c,position,2E3)}},60*l)})(l);c(f)})):b("Node not found")})};a.removeOutOfDepthNodes=function(){g(a.currentNode,-1,[]);for(var f=0;f<a.scene.children.length;f++)if(void 0!==a.scene.children[f].node){var d=a.scene.children[f].node;d._depth>
a.options.maxDepth&&a.removeNodeWithRelationships(d.id)}};a.selectNode=function(f){f=a.findNode(f);void 0!==f&&(a.cameraLookAtPosition(f.position),a.currentNode=f.node,document.getElementById("graph").dispatchEvent(new Event("currentNode")),a.updateBackground(f.node))};a.findNode=function(f){for(var d=0;d<a.scene.children.length;d++)if(a.scene.children[d].node.id===f)return a.scene.children[d]};a.findRelationship=function(f,d){for(var c=0;c<a.linesScene.children.length;c++){var b=a.linesScene.children[c];
if("Line"===b.type&&(f===b.startNodeId&&d===b.endNodeId||d===b.startNodeId&&f===b.endNodeId))return b}};a.removeRelationship=function(f,d){return new Promise(function(c,b){var e=a.findRelationship(f,d);void 0!==e?(e.geometry.dispose(),e.material.dispose(),a.linesScene.remove(e),c()):b("Relationship not found")})};a.removeNode=function(f){return new Promise(function(d,c){var b=a.findNode(f);void 0!==b?(new TWEEN.Tween(b.scale)).to({x:0,y:0,z:0},500).easing(TWEEN.Easing.Linear.None).onComplete(function(){for(var c=
b.children.length-1;0<=c;c--){var n=b.children[c];n.geometry.dispose();n.material.map.dispose();n.material.dispose();b.remove(n)}b.geometry.dispose();b.material.map.dispose();b.material.dispose();a.scene.remove(b);d()}).start():c("Node not found")})};a.removeNodeWithRelationships=function(f){a.removeNode(f);for(var d=a.linesScene.children.length-1;0<=d;d--){var c=a.linesScene.children[d];"Line"!==c.type||c.startNodeId!==f&&c.endNodeId!==f||(c.geometry.dispose(),c.material.dispose(),a.linesScene.remove(c))}};
a.removeRelatedNodes=function(f,d){for(var c=a.linesScene.children.length-1;0<=c;c--){var b=a.linesScene.children[c];"Line"!==b.type||b.startNodeId!==f&&b.endNodeId!==f||void 0!==d&&b._type!==d||(a.removeNode(b.startNodeId!==f?b.startNodeId:b.endNodeId),b.material.dispose(),b.geometry.dispose(),a.linesScene.remove(b))}};a.displayCinegraphNodes=function(f,d){var c=d&&0<f.length;if(c)for(var b=[],e=0;e<f.length;e++){var n=f[e];null!=n.start&&-1==b.indexOf(n.start)&&b.push(n.start);null!=n.end&&-1==
b.indexOf(n.end)&&b.push(n.end)}d&&void 0!=a.scope.currentCinegraph.nodes&&(f=f.concat(a.scope.currentCinegraph.nodes));var g=a.getCinegraphPositions(f,d),l;for(l in g)e=a.findNode(l),void 0===e||e.IsSuggested?a.addNode(l,g[l]).then(function(l){l==Object.keys(g)[0]&&a.selectNode(l);c&&-1!==b.indexOf(parseInt(l))&&p(l)}):d&&(new TWEEN.Tween(e.position)).to({x:g[l].x,y:g[l].y,z:g[l].z},1E3).easing(TWEEN.Easing.Linear.None).start();for(e=0;e<f.length;e++)if(n=f[e],null!=n.start&&null!=n.end){var r=a.findRelationship(n.start,
n.end);void 0===r?(r=h(g[n.end],n.type,!1),r.endNodeId=n.end,r.startNodeId=n.start,a.linesScene.add(r),a.animateLine(r,g[n.start],g[n.end])):d&&a.animateLine(r,g[n.start],g[n.end])}n=new THREE.Vector3(0,0,0);if(c){for(e=0;e<b.length;e++)n.add(g[b[e]]);n.divideScalar(0<b.length?b.length:1)}else{for(l in g)n.add(g[l]);n.divideScalar(Object.keys(g).length)}a.cameraLookAtPosition(n)};a.refreshGraph=function(){a.removeFilters();a.displayCinegraphNodes([],!0)};a.removeSuggestions=function(){};return a}(CINEGRAPH||
{});CINEGRAPH=function(a){function m(b){b=b||window.event;var d=(b.target||b.srcElement).getBoundingClientRect(),e=b.clientX-d.left;b=b.clientY-d.top;c.x=e/a.viewWidth*2-1;c.y=2*-(b/a.viewHeight)+1;c.clientX=e;c.clientY=b}function k(a,b,d,c){if(d<a){var e=a;a=d;d=e;e=b;b=c;c=e}0>=$("#line").length?(e=document.createElement("div"),e.style.borderBottom="8px solid",e.style.borderColor="red",e.style.position="absolute",e.style.zIndex="99999",e.id="line",$("#graph").before(e),$("#line").mouseup(function(){$("#graph").trigger("mouseup")})):
e=$("#line")[0];var n=Math.sqrt((a-d)*(a-d)+(b-c)*(b-c));e.style.width=n+"px";-1<navigator.userAgent.indexOf("MSIE")?(e.style.top=c>b?b+"px":c+"px",e.style.left=a+"px",a=(d-a)/n,b=(c-b)/n,e.style.filter="progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+a+", M12="+-1*b+", M21="+b+", M22="+a+")"):(c=Math.atan((c-b)/(d-a)),e.style.top=b+.5*n*Math.sin(c)+"px",e.style.left=a-.5*n*(1-Math.cos(c))+"px",e.style.transform=e.style.MozTransform=e.style.WebkitTransform=e.style.msTransform=
e.style.OTransform="rotate("+c+"rad)")}function g(l){m(l);if(e)a.options.enablePathfinding&&b.onNode&&(f=d(),0<f.length&&(l=f[0].object._id,void 0!=l&&-1==$.inArray(l,b.cinegraphPath)&&b.cinegraphPath.push(l)),k(b.clientX,b.clientY,c.clientX,c.clientY));else{l=d();var f=void 0;if(0<l.length){f=l[0].object;if(f.isOverlaySprite||f.isOutlineSprite)f=f.parent;if(f===n)return;f.onHover()}if(void 0!==n&&void 0!==n.onLeave)n.onLeave();n=f}}function h(l){m(l);b.x=c.x;b.y=c.y;b.clientX=c.clientX;b.clientY=
c.clientY;b.onNode=!1;b.cinegraphPath=[];a.options.enablePathfinding?1==l.which&&(0<d().length&&(b.onNode=!0,a.cameraControls.enabled=!1),e=!0):e=!0}function p(l){m(l);e=!1;a.cameraControls.enabled=!0;if(a.options.enablePathfinding&&($("#line").remove(),b.onNode&&1<b.cinegraphPath.length)){l=a.findNode(b.cinegraphPath[0]);var n=a.findNode(b.cinegraphPath[b.cinegraphPath.length-1]);a.findCinegraphPath(l,n)}b.onNode=!1;if(c.x==b.x&&c.y==b.y)if(l=d()[0],void 0==l)a.removeSuggestions(),a.removeFilters(a.currentNode.id);
else{if(l.object.isOutlineSprite||l.object.isOverlaySprite)l.object=l.object.parent;if(void 0!=l.object.node)n=l.object.node.id,a.removeFilters(a.currentNode.id),n===a.currentNode.id&&f(n),a.cameraLookAtNode(n),a.currentNode.sprite=l.object,a.selectNode(n),a.addRelatedNodes(n).then(function(b){a.removeOutOfDepthNodes()});else if(l.object.isChildButton)l.object.onClick()}}function f(b){var d=a.findNode(b),c=Math.PI/6;if(void 0!=d){var e=4;for(job in a.relationships){e++;var n=function(d){return function(){var c=
this.parent.node._relationships[d];c.active=!c.active;if(this.active=c.active){this.onHover();var e={};e[d]=c;a.addRelatedNodes(b,e)}else this.onLeave(),a.removeRelatedNodes(b,d)}}(job);a.addChildButton(d,.667,c*e,.33,job,a.relationships[job].color,n,d.node._relationships[job].active)}}}function d(){u.setFromCamera(c,a.camera);return u.intersectObjects(a.scene.children,!0)}var c,b,e,n,u;a.initInput=function(){c=new THREE.Vector2;b={};e=!1;n=void 0;u=new THREE.Raycaster;$("#graph").off("mousedown").on("mousedown",
h);$("#graph").off("mouseup").on("mouseup",p);$("#graph").off("mousemove").on("mousemove",g);a.cameraControls.addEventListener("change",function(){a.renderNeedsUpdate=!0});$(document).keyup(a.switchRenderMode);window.addEventListener("resize",a.onWindowResize,!1)};a.destroyInput=function(){u=null;$(document).unbind("keyup",a.switchRenderMode);$("#graph").off("mousedown");$("#graph").off("mouseup");$("#graph").off("mousemove")};a.updateHoverLabel=function(a){};a.updateHoverLabelPosition=function(){};
a.addChildButton=function(b,d,c,e,n,f,g,h){var k=a.getButtonSprite(n,f);k.scale.set(0,0,0);k.position.set(Math.cos(c)*d,Math.sin(c)*d,0);k.active=h;k.active&&(k.children[0].material.opacity=1);k.onClick=g;k.onHover=function(){$("#graph").css({cursor:"pointer"});(new TWEEN.Tween(k.children[0].material)).to({opacity:this.active?.8:1},300).easing(TWEEN.Easing.Linear.None).start()};k.onLeave=function(){$("#graph").css({cursor:"default"});(new TWEEN.Tween(k.children[0].material)).to({opacity:this.active?
1:0},300).easing(TWEEN.Easing.Linear.None).start()};b.add(k);a.animateNodeScale(k,e,250,0)};a.removeFilters=function(b){var d=a.findNode(b);if(void 0!==d)for(b=d.children.length-1;0<=b;b--){var c=d.children[b];c.isChildButton&&function(a){(new TWEEN.Tween(a.scale)).to({x:0,y:0,z:0},180).easing(TWEEN.Easing.Linear.None).onComplete(function(){a.geometry.dispose();a.material.dispose();d.remove(a)}).start()}(c)}};THREE.Sprite.prototype.raycast=function(){var a=new THREE.Vector3;return function(b,d){a.setFromMatrixPosition(this.matrixWorld);
var c=b.ray.distanceSqToPoint(a),e=this.scale.x*this.scale.y;8==this.scale.x?e=14:.33==this.scale.x?e=1.63:.23==this.scale.x&&(e=.8);c>e||d.push({distance:Math.sqrt(c),point:this.position,face:null,object:this})}}();return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(k){for(var g=0;g<k.length;g++){for(var h=k[g],p=!0,f=!0,d=!0,c=0;c<a.scope.currentCinegraph.nodes.length;c++){var b=a.scope.currentCinegraph.nodes[c];h.start==b.start&&h.end==b.end&&(p=!1);if(h.start==b.start||h.start==b.end)f=!1;if(h.end==b.start||h.end==b.end)d=!1}p&&a.removeRelationship(h.start,h.end);f&&a.removeNode(h.start);d&&a.removeNode(h.end)}}a.findCinegraphPath=function(k,g){if(void 0!=k&&void 0!=g){var h=$('<div id="canvasPathPanel"><h3 class="inline">Searching for paths...</h3></div>');
$("#graph").after(h.hide().slideDown(500));$http.get("/api/mycinegraph/path/"+k._id+"/"+g._id).success(function(g){for(var f=0;f<g.length;f++)for(var d=g[f],c=0;c<d.length;c++)d[c]=JSON.parse(d[c]);h.paths=g;h.current=0;h.find("h3").text("Path 1 of "+g.length+":");a.displayCinegraphNodes(h.paths[h.current],!0);h.append('<a href="#" class="btn btn-s-md btn-success canvasPathPanelAdd m-l m-t v-top">Add</a>\r\n                <a href="#" class="btn btn-s-md btn-default canvasPathPanelPrevious m-t v-top">Previous</a>\r\n                <a href="#" class="btn btn-s-md btn-default canvasPathPanelNext m-t v-top">Next</a>\r\n                <a href="#" class="btn btn-s-md btn-default canvasPathPanelCancel m-t v-top">Cancel</a>');
$(".canvasPathPanelCancel").click(function(){$("#canvasPathPanel").slideUp().remove();m(h.paths[h.current])});$(".canvasPathPanelNext").click(function(){h.current<h.paths.length-1&&(m(h.paths[h.current]),h.current++,h.find("h3").text("Path "+(h.current+1)+" of "+g.length+":"),a.displayCinegraphNodes(h.paths[h.current],!0))});$(".canvasPathPanelPrevious").click(function(){0<h.current&&(m(h.paths[h.current]),h.current--,h.find("h3").text("Path "+(h.current+1)+" of "+g.length+":"),a.displayCinegraphNodes(h.paths[h.current],
!0))});$(".canvasPathPanelAdd").click(function(){for(var b=h.paths[h.current],d=0;d<b.length;d++){for(var c=b[d],f=!0,l=0;l<a.scope.currentCinegraph.nodes.length;l++){var g=scope.currentCinegraph.nodes[l];if(c.start==g.start&&c.end==g.end){f=!1;break}}f&&scope.currentCinegraph.nodes.push(c)}for(d=scope.currentCinegraph.nodes.length-1;0<=d;d--)if(c=scope.currentCinegraph.nodes[d],null==c.start||null==c.end)for(b=null!=c.start?c.start:c.end,l=0;l<scope.currentCinegraph.nodes.length;l++)if(l!=d&&(g=
scope.currentCinegraph.nodes[l],g.start==b||g.end==b)){scope.currentCinegraph.nodes.splice(d,1);break}$http.put("/api/mycinegraph/"+scope.currentCinegraph.id,{titleCinegraph:scope.currentCinegraph.title,cinegraphNodes:JSON.stringify(scope.currentCinegraph.nodes)});$("#canvasPathPanel").slideUp(500).remove()})})}};return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(a,h){var k;for(k=0;k<a.length;++k)if(200>=a[k].distanceToSquared(h))return!1;return!0}function k(g,h,k,f){var d=g.start;g=g.end;if(null!=d&&void 0==h[d]){var c=void 0!=h[g]?h[g]:new THREE.Vector3(0,0,0),b=a.findNode(d);h[d]=void 0==b||f?a.getNextPosition(k,c):b.position;k.push(h[d])}null!=g&&void 0==h[g]&&(c=void 0!=h[d]?h[d]:new THREE.Vector3(0,0,0),b=a.findNode(g),h[g]=void 0==b||f?a.getNextPosition(k,c):b.position,k.push(h[g]))}a.getNewPosition=function(){return a.getNextPosition(a.getOccupiedPositions(),
new THREE.Vector3(0,0,0))};a.getOccupiedPositions=function(){for(var g=[],h=a.scene.children.length-1;0<=h;h--)"Sprite"==a.scene.children[h].type&&g.push(a.scene.children[h].position);for(h=TWEEN.getAll().length-1;0<=h;h--){var k=TWEEN.getAll()[h].getValuesEnd();void 0!=k.x&&void 0!=k.y&&void 0!=k.z&&g.push(new THREE.Vector3(k.x,k.y,k.z))}return g};a.getNextPosition=function(a,h){for(var k=18,f=h.clone(),d=0;!m(a,f);)f.x=2*Math.random()-1,f.y=2*Math.random()-1,f.z=2*Math.random()-1,f.setLength(k).round().add(h),
d++,0==d%50&&(k=18*(1+d/50));return f};a.getCinegraphPositions=function(g,h){positions=[];for(var m=1==h?[]:a.getOccupiedPositions(),f=0;f<g.length;f++){k(g[f],positions,m,h);for(var d=g[f].start,c=g[f].end,b=f+1;b<g.length;b++)g[b].start!=d&&g[b].end!=d||k(g[b],positions,m,h);for(b=f+1;b<g.length;b++)g[b].start!=c&&g[b].end!=c||k(g[b],positions,m,h)}return positions};return a}(CINEGRAPH||{});CINEGRAPH=function(a){var m,k,g,h,p,f,d,c,b,e,n,u;a.renderNeedsUpdate=!1;a.initRender=function(){e=d=f=p=0;n=1;u=0;a.renderNeedsUpdate=!1;m=new THREE.WebGLRenderer({antialias:!1,alpha:!0,autoClear:!1});m.setSize(a.viewWidth,a.viewHeight);document.getElementById("graph").appendChild(m.domElement);var l={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},r=new THREE.WebGLRenderTarget(1*a.viewWidth,1*a.viewHeight,l),w=new THREE.RenderPass(a.linesScene,
a.camera),q=new THREE.ShaderPass(THREE.ThickLineShader);q.uniforms.totalWidth.value=1*a.viewWidth;q.uniforms.totalHeight.value=1*a.viewHeight;q.uniforms.edgeWidth.value=6;k=new THREE.EffectComposer(m,r);k.addPass(w);k.addPass(q);l=new THREE.WebGLRenderTarget(1*a.viewWidth,1*a.viewHeight,l);r=new THREE.RenderPass(a.scene,a.camera);w=new THREE.ShaderPass(THREE.CopyShader);g=new THREE.EffectComposer(m,l);g.addPass(r);g.addPass(w);l=new THREE.ShaderPass(THREE.BlendShader);l.uniforms.tBase.value=k.renderTarget1;
l.uniforms.tAdd.value=g.renderTarget1;l.renderToScreen=!0;h=new THREE.EffectComposer(m);h.addPass(l);b=new THREEx.RendererStats;b.domElement.style.position="absolute";b.domElement.style.right="0px";b.domElement.style.bottom="0px";b.domElement.style.display="none";b.domElement.id="rendererStats";c=new Stats;c.setMode(0);c.domElement.style.position="absolute";c.domElement.style.right="80px";c.domElement.style.bottom="0px";c.domElement.style.display="none";document.body.appendChild(b.domElement);document.body.appendChild(c.domElement)};
a.destroyRender=function(){cancelAnimationFrame(d);a.scene=null;a.linesScene=null;a.cameraControls=null;document.body.removeChild(c.domElement);document.body.removeChild(b.domElement);b=c=null};a.animate=function(){d=requestAnimationFrame(a.animate);c.begin();b.update(m);var e=(new Date).getTime();TWEEN.update();a.cameraControls.update();var r=u;u=TWEEN.getAll().length;if(a.renderNeedsUpdate||0<u||0<r&&0==u){for(r=0;r<a.scene.children.length;r++){var w=a.scene.children[r];"Sprite"==w.type&&(w.lookAt(a.camera.position),
w.quaternion.copy(a.camera.quaternion))}m.clear();k.render();a.updateHoverLabelPosition(a.currentNode);a.updateGradientLayer();g.render();h.render();a.renderNeedsUpdate=!1;r=(new Date).getTime();120>f?(f++,p+=r-e):(e=p/120,33.33<e&&.5<n?(n=Math.max(.5,.75*n),a.onWindowResize()):20>e&&1>n&&(n=Math.min(1,1.25*n),a.onWindowResize()),f=p=0)}c.end()};a.onWindowResize=function(){a.viewWidth=$("#graph").find("canvas").width(0).parent().width();a.viewHeight=$("#graph").find("canvas").height(0).parent().height();
a.camera.aspect=a.viewWidth/a.viewHeight;a.camera.updateProjectionMatrix();m.setSize(a.viewWidth,a.viewHeight);var b=1*a.viewWidth*n,d=1*a.viewHeight*n;k.setSize(b,d);var c=k.passes[1];c.uniforms.totalWidth.value=b;c.uniforms.totalHeight.value=d;c.uniforms.edgeWidth.value=6*n;g.setSize(b,d);h.setSize(b/1,d/1);b=h.passes[0];b.uniforms.tBase.value=k.renderTarget1;b.uniforms.tAdd.value=g.renderTarget1;a.renderNeedsUpdate=!0};a.switchRenderMode=function(b){switch(b.which){case 112:e=(e+1)%3;k.passes[k.passes.length-
1].renderToScreen=1==e;g.passes[g.passes.length-1].renderToScreen=2==e;h.passes[h.passes.length-1].renderToScreen=0==e;a.renderNeedsUpdate=!0;break;case 113:$("#stats, #rendererStats").toggle();break;default:return}b.preventDefault()};return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(a,c,b,e,f,g){if(-1==c.indexOf(" "))a.fillText(c,b,e,f);else{c=c.split(" ");for(var l="",h=0,k=0;k<c.length;k++){var m=l+c[k]+" ";if(a.measureText(m).width>f&&0<k){h++;if(3==h){a.fillText(l.slice(0,-1)+"...",b,e,f);return}a.fillText(l,b,e,f);l=c[k]+" ";e+=g}else l=m}a.fillText(l,b,e,f)}}function k(a,c,b){var e=document.createElement("canvas");e.width=256;e.height=256;var n=e.width/2,g=e.height/2,l=e.getContext("2d");l.beginPath();l.arc(n,g,n,0,f);l.clip();l.fillStyle=
c;l.fillRect(0,0,e.width,e.height);l.fillStyle=b;l.font="bold 100px Arial";l.textAlign="center";l.textBaseline="middle";l.fillText(a.toUpperCase().substring(0,2),n,n);return e}function g(a,c,b,e,f,g,l,h){2===arguments.length&&(b=e=0,f=a.canvas.width,g=a.canvas.height);l="number"===typeof l?l:.5;h="number"===typeof h?h:.5;0>l&&(l=0);0>h&&(h=0);1<l&&(l=1);1<h&&(h=1);var k=c.width,m=c.height,p=Math.min(f/k,g/m),t=Math.round(k*p),p=Math.round(m*p),v,x;v=1;t<f&&(v=f/t);p<g&&(v=g/p);t=k/(t*v/f);x=m/(p*
v/g);p=(k-t)*l;v=(m-x)*h;0>p&&(p=0);0>v&&(v=0);t>k&&(t=k);x>m&&(x=m);a.drawImage(c,p,v,t,x,b,e,f,g)}var h,p,f=2*Math.PI;a.initTexture=function(){h=new Image;h.src="images/default_bg2.jpg";p=[]};a.getDefaultImage=function(){return h};a.getNodeOpacity=function(){return.6};a.updateGradientLayer=function(){for(var d=0;d<a.scene.children.length;d++){var c=a.scene.children[d],b=a.getSpriteRadius(c.position,c.scale.x);if(!(2>=b)){var e=a.toScreenPosition(c.position);if(!(0>e.x+b||e.x-b>a.viewWidth||0>e.y+
b||e.y-b>a.viewHeight)){for(var g=0;g<c.children.length;g++)c.children[g].gradientIsActive=!1;for(b=a.linesScene.children.length-1;0<=b;b--)if(e=a.linesScene.children[b],"Line"==e.type){var h;if(e.endNodeId==c._id)h=0;else if(e.startNodeId==c._id)h=1;else continue;var l=0==h?1:0;if(!(16>=e.geometry.vertices[h].distanceToSquared(e.geometry.vertices[l]))){var k="#"+e.geometry.colors[h].getHexString();if(k!==c.node._color){h=a.toScreenPosition(e.geometry.vertices[h]);for(var m=a.toScreenPosition(e.geometry.vertices[l]),
e=e.startNodeId+","+e.endNodeId,l=!1,g=0;g<c.children.length;g++){var q=c.children[g];if(q.lineId==e){l=!0;h=m.sub(h);m=(new THREE.Vector3(1,0,0)).angleTo(h);q.material.rotation=0<h.y?-m:m;q.gradientIsActive=!0;break}}l||(void 0==p[k]&&(h=new THREE.Color(k),l=document.createElement("canvas"),l.width=256,l.height=256,q=l.width/2,m=l.getContext("2d"),m.beginPath(),m.arc(q,q,q,0,f),m.clip(),m.fillStyle="rgba("+255*h.r+","+255*h.g+","+255*h.b+",0)",m.fill(),m.shadowOffsetX=1E3,m.shadowOffsetY=1E3,m.shadowBlur=
q/2.5,m.fillStyle=k,m.shadowColor=k,m.beginPath(),m.arc(2*q-m.shadowOffsetX,q-m.shadowOffsetY,q-1.2*m.shadowBlur,0,f,!0),m.fill(),p[k]=l),k=new THREE.Texture(p[k]),h=new THREE.SpriteMaterial({map:k,transparent:!0}),h=new THREE.Sprite(h),k.needsUpdate=!0,q=h,q.lineId=e,c.add(q),q.gradientIsActive=!0)}}}for(g=0;g<c.children.length;g++)q=c.children[g],q.gradientRemoveDisable||q.gradientIsActive||(q.geometry.dispose(),q.material.dispose(),c.remove(q))}}}};a.getNodeSprite=function(d){var c=d.name?d.firstname+
" "+d.lastname:d.title,b=a.generateTexture(void 0!=d.jobs?d.jobs[0].name:void 0,a.getDefaultImage(),c),e=new THREE.Texture(b);e.minFilter=THREE.LinearFilter;e.needsUpdate=!0;var f=new THREE.Sprite(new THREE.SpriteMaterial({map:e}));f._id=d.id;f.name=c;f.canvas=b;f.texture=e;f.mainJob=Object.keys(d._relationships)[0];f.node=d;void 0==d.img||0==d.img?f.nodeImage=a.getDefaultImage():(f.nodeImage=new Image,f.nodeImage.src=void 0==d.title?"images/persons/"+a.sanitizeFileName(d.fullname)+".jpg":"images/movies/"+
a.sanitizeFileName(d.title+d.released)+"/poster.jpg",f.nodeImage.onerror=function(){this.src="images/default.jpg"},f.nodeImage.onload=function(){a.updateTexture(f.mainJob,f.nodeImage,f.canvas,f.name);f.texture.needsUpdate=!0});d=a.generateSpriteBackground(f);d.material.depthTest=!1;d.isOutlineSprite=!0;d.position.set(0,0,-1E-6);f.add(d);var g=a.generateSpriteOverlay(c,f.node._color);g.material.depthTest=!1;g.isOverlaySprite=!0;g.position.set(0,0,1E-4);f.add(g);f.onHover=function(){$("#graph").css({cursor:"pointer"});
g.onHover();a.updateHoverLabel(this.name)};f.onLeave=function(){$("#graph").css({cursor:"default"});g.onLeave()};return f};a.generateSpriteBackground=function(a){var c=document.createElement("canvas");c.width=256;c.height=256;var b=c.getContext("2d");b.beginPath();var e=c.width/2;b.arc(e,e,e,0,f);b.clip();b.fillStyle=a.node._color;b.fillRect(0,0,c.width,c.height);c=new THREE.Texture(c);a=new THREE.SpriteMaterial({map:c});a=new THREE.Sprite(a);a.gradientRemoveDisable=!0;c.needsUpdate=!0;return a};
a.generateSpriteOverlay=function(a,c){var b=document.createElement("canvas");b.width=256;b.height=256;var e=b.width/24,g=b.width/2,h=b.height/2,l=b.getContext("2d");l.beginPath();l.arc(g,h,g-e,0,f);l.clip();l.fillStyle="#000000";l.fillRect(0,0,b.width,b.height);l.fillStyle="#ffffff";l.font="bold "+b.width/9+"px Arial";l.textAlign="center";m(l,a.toUpperCase(),g,b.height/2.5,b.width-5*e,b.height/6);b=new THREE.Texture(b);e=new THREE.SpriteMaterial({map:b,transparent:!0,opacity:.6});e=new THREE.Sprite(e);
e.gradientRemoveDisable=!0;b.needsUpdate=!0;e.onHover=function(){(new TWEEN.Tween(this.material)).to({opacity:0},300).easing(TWEEN.Easing.Linear.None).start()};e.onLeave=function(){(new TWEEN.Tween(this.material)).to({opacity:.6},300).easing(TWEEN.Easing.Linear.None).start()};return e};a.generateTexture=function(d,c,b){var e=document.createElement("canvas");e.width=256;e.height=256;a.updateTexture(d,c,e,b,.6);return e};a.updateTexture=function(a,c,b,e,h){a=b.width/24;e=b.width/2;h=b.height/2;var k=
b.getContext("2d");k.beginPath();k.arc(e,h,e-a,0,f);k.clip();g(k,c,a,a,b.width-2*a,b.height-2*a)};a.getButtonSprite=function(a,c){var b=new THREE.SpriteMaterial({map:new THREE.Texture(k(a,"#222222",c))}),b=new THREE.Sprite(b);b.material.map.needsUpdate=!0;b.material.depthTest=!1;b.isChildButton=!0;b.gradientRemoveDisable=!0;var e=new THREE.SpriteMaterial({map:new THREE.Texture(k(a,c,"#222222"))}),e=new THREE.Sprite(e);e.material.depthTest=!1;e.material.opacity=0;e.material.map.needsUpdate=!0;e.isOverlaySprite=
!0;e.scale.set(1.02,1.02,1.02);e.position.set(0,0,1E-4);b.add(e);return b};a.sanitizeFileName=function(a){return void 0==a?a:a.replace(RegExp('[,/:*?""<>|]',"g"),"_")};a.updateBackground=function(d){var c=$("#graph").find(".canvasBackground"),b=$('<div class="canvasBackground"></div>');$("#graph").find("canvas").before(b);if(void 0==d.img||0==d.img)b.css("opacity"),b.css({"background-image":'url("'+h.src+'")',opacity:1,top:0<c.length?"-100%":"0"}),setTimeout(function(){c.remove();b.css("top","0")},
1E3);else{var e=new Image;e.src=void 0==d.title?"images/persons/"+a.sanitizeFileName(d.fullname)+".jpg":"images/movies/"+a.sanitizeFileName(d.title+d.released)+"/backdrop.jpg";e.onerror=function(){this.src="images/movies/"+a.sanitizeFileName(d.title+d.released)+"/poster.jpg";e.onerror=function(){this.src="images/default.jpg"}};e.onload=function(){b.css({"background-image":'url("'+e.src+'")',opacity:1,top:0<c.length?"-100%":"0"});setTimeout(function(){c.remove();b.css("top","0")},1E3)}}};return a}(CINEGRAPH||
{});
