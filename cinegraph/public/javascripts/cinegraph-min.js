var CINEGRAPH=function(a){a.animateNodeScale=function(a,l,c,g){l=void 0!==l?l:8;c=void 0!==c?c:200;g=void 0!==g?g:940;(new TWEEN.Tween(a.scale)).to({x:l,y:l,z:l},c).delay(g).easing(TWEEN.Easing.Linear.None).start()};a.animateNodePosition=function(a,l,c){void 0!==l&&(new TWEEN.Tween(a.position)).to({x:l.x,y:l.y,z:l.z},c).easing(TWEEN.Easing.Elastic.InOut).start()};a.animateNodeAndLine=function(a,l,c,g){(new TWEEN.Tween(a.position)).to({x:c.x,y:c.y,z:c.z},g).easing(TWEEN.Easing.Elastic.InOut).onUpdate(function(){l.geometry.vertices[0].set(a.position.x,
a.position.y,a.position.z);l.geometry.verticesNeedUpdate=!0}).start()};a.animateLine=function(a,l,c){(new TWEEN.Tween(a.geometry.vertices[1])).to({x:l.x,y:l.y,z:l.z},1E3).easing(TWEEN.Easing.Linear.None).onUpdate(function(){a.geometry.verticesNeedUpdate=!0}).start();(new TWEEN.Tween(a.geometry.vertices[0])).to({x:c.x,y:c.y,z:c.z},1E3).easing(TWEEN.Easing.Linear.None).onUpdate(function(){a.geometry.verticesNeedUpdate=!0}).start()};return a}(CINEGRAPH||{});CINEGRAPH=function(a){a.cameraControls=null;a.camera=null;a.initCamera=function(){$("#graph").css("height","100%");a.viewWidth=$("#graph").width();a.viewHeight=$("#graph").height();a.camera=new THREE.PerspectiveCamera(70,a.viewWidth/a.viewHeight,1,1E3);a.camera.position.set(0,0,33);a.cameraControls=new THREE.TrackballControls(a.camera,document.getElementById("graph"));a.cameraControls.rotateSpeed=2;a.cameraControls.zoomSpeed=1.2;a.cameraControls.panSpeed=.8;a.cameraControls.noZoom=!1;a.cameraControls.noPan=
!1;a.cameraControls.staticMoving=!0;a.cameraControls.dynamicDampingFactor=.3;a.cameraControls.keys=[65,83,68]};a.cameraLookAtPosition=function(m){var l=(new THREE.Vector3).copy(a.camera.position).sub(m).setLength(33).add(m);(new TWEEN.Tween(a.camera.position)).to({x:l.x,y:l.y,z:l.z},1E3).easing(TWEEN.Easing.Exponential.Out).start();(new TWEEN.Tween(a.cameraControls.target)).to({x:m.x,y:m.y,z:m.z},1E3).easing(TWEEN.Easing.Exponential.Out).start()};a.cameraLookAtNode=function(m){m=a.findNode(m);void 0!=
m&&a.cameraLookAtPosition(m.position)};a.getSpriteRadius=function(m,l){var c=new THREE.Vector3,g=new THREE.Vector3(0,0,-1),q=new THREE.Vector3,h=new THREE.Vector3;c.copy(m).sub(a.camera.position);g.applyQuaternion(a.camera.quaternion);0==c.angleTo(g)&&(c.x+=1E-5);q.crossVectors(c,g).setLength(4);h.copy(m).add(q);return a.toScreenPosition(h).distanceTo(a.toScreenPosition(m))*l/8};a.toScreenPosition=function(m){var l=new THREE.Vector3;l.copy(m);m=.5*a.viewWidth;var c=.5*a.viewHeight;l.project(a.camera);
l.x=l.x*m+m;l.y=-(l.y*c)+c;return new THREE.Vector3(l.x,l.y,0)};return a}(CINEGRAPH||{});CINEGRAPH=function(a){a.scene=null;a.linesScene=null;a.viewWidth=0;a.viewHeight=0;a.currentNode=null;a.options={enablePathfinding:!1,maxDepth:1};a.relationships={ACTED_IN:{limit:4,color:"#319ef1"},DIRECTED:{limit:1,color:"#8e44ad"},PRODUCED:{limit:1,color:"#27ae60"},COMPOSED_MUSIC:{limit:1,color:"#00d6ce"},DIRECTED_PHOTOGRAPHY:{limit:1,color:"#fc6e51"},WROTE:{limit:1,color:"#f1c40f"},EDITED:{limit:1,color:"#e33244"},DESIGNED_PRODUCTION:{limit:1,color:"#ac92ec"},DESIGNED_COSTUMES:{limit:1,color:"#ec87c0"}};
a.types={Movie:{color:"#ffa226"}};a.initScene=function(){a.scene=new THREE.Scene;a.linesScene=new THREE.Scene;a.linesScene.add(a.camera)};a.init=function(m){$http=m;$("#graph").css("opacity",0);a.initCamera();a.initScene();a.initRender();a.initTexture();a.initInput();a.animate();$("#graph").animate({opacity:1},4E3)};a.destroy=function(){a.destroyRender();a.destroyInput()};return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(h){if(void 0!==a.types[h.label]&&void 0!==a.types[h.label].color)return a.types[h.label].color;var e=Object.keys(h._relationships)[0],f;for(f in h._relationships)h._relationships[f].count>h._relationships[e].count&&(e=f);return a.relationships[e].color}function l(h){var e={},f;for(f in a.relationships)e[f]={skip:0,limit:a.relationships[f].limit,active:!0,count:void 0!==h[f]?h[f]:0};return e}function c(h,e,f){h._depth=e+1;f.push(h.id);for(var b=h._neighbours.length-
1;0<=b;b--){var d=a.findNode(h._neighbours[b]);void 0!==d?(-1===f.indexOf(d.node.id)||e+1<d.node._depth)&&c(d.node,h._depth,f):h._neighbours.splice(b,1)}}function g(h,e,f){var b=new THREE.Geometry;b.vertices.push(h.clone(),h.clone());f?(h=a.relationships[e].color,e=a.types.Movie.color):(h=a.types.Movie.color,e=a.relationships[e].color);b.colors.push(new THREE.Color(h));b.colors.push(new THREE.Color(e));return new THREE.Line(b,new THREE.LineBasicMaterial({linewidth:1,vertexColors:!0}))}function q(h){h=
a.findNode(h);if(void 0!=h){var e=new THREE.MeshBasicMaterial({color:new THREE.Color(void 0!=h.mainJob?a.colors[h.mainJob]:a.orangeColor),transparent:!0,opacity:.5,depthWrite:!1}),e=new THREE.Mesh(new THREE.CircleGeometry(.65,32),e);e.scale.set(.9,.9,.9);e.tween=(new TWEEN.Tween(e.scale)).to({x:1,y:1,z:1},1300).easing(TWEEN.Easing.Quartic.InOut).onComplete(function(){}).yoyo(!0).repeat(Infinity);e.tween.start();e.IsSuggestionCircle=!0;e.gradientRemoveDisable=!0;h.IsSuggested=!0;h.add(e)}}a.addNode=
function(h,e){return new Promise(function(f,b){void 0===a.findNode(h)?$http.get("/api/common/"+h).success(function(b){var k=b.node;k._relationships=l(b.relationships);k._color=m(k);k._depth=0;k._neighbours=[];b=a.getNodeSprite(k);b.scale.set(0,0,0);e=void 0!==e?e:a.getNewPosition();b.position.set(e.x,e.y,e.z);a.scene.add(b);a.animateNodeScale(b);f(h)}):b("Node not found")})};a.addRelatedNodes=function(h){return new Promise(function(e,f){var b=a.findNode(h);void 0!==b?$http.get("/api/common/related/"+
h+"/"+JSON.stringify(b.node._relationships)).success(function(d){for(var f=a.getOccupiedPositions(),c=0;c<d.length;c++)(function(e){setTimeout(function(){if(void 0===a.findNode(d[e].node.id)){var n=d[e].node;n.label=d[e].label;for(var t=d[e].relationships,c={},u=0;u<t.length;u++)c[t[u][0]]=t[u][1];n._relationships=l(c);n._color=m(n);n._depth=b._depth+1;n._neighbours=[b.node.id];b.node._neighbours.push(n.id);t=a.getNodeSprite(n);t.scale.set(0,0,0);position=a.getNextPosition(f,b.position);f.push(position);
t.position.set(b.position.x,b.position.y,b.position.z);a.scene.add(t);n=g(b.position,d[e].type,n.name);n.endNodeId=t.node.id;n.startNodeId=h;a.linesScene.add(n);a.animateNodeScale(t);a.animateNodeAndLine(t,n,position,2E3)}},60*e)})(c);e(h)}):f("Node not found")})};a.removeOutOfDepthNodes=function(){c(a.currentNode,-1,[]);for(var h=0;h<a.scene.children.length;h++)if(void 0!==a.scene.children[h].node){var e=a.scene.children[h].node;e._depth>a.options.maxDepth&&a.removeNodeWithRelationships(e.id)}};
a.selectNode=function(h){h=a.findNode(h);void 0!==h&&(a.cameraLookAtPosition(h.position),a.currentNode=h.node,document.getElementById("graph").dispatchEvent(new Event("currentNode")),a.updateBackground(h.node))};a.findNode=function(h){for(var e=0;e<a.scene.children.length;e++)if(a.scene.children[e].node.id==h)return a.scene.children[e]};a.findRelationship=function(h,e){for(var f=0;f<a.linesScene.children.length;f++){var b=a.linesScene.children[f];if("Line"==b.type&&(h==b.startNodeId&&e==b.endNodeId||
e==b.startNodeId&&h==b.endNodeId))return b}};a.removeRelationship=function(h,e){return new Promise(function(f,b){var d=a.findRelationship(h,e);void 0!=d?(d.geometry.dispose(),d.material.dispose(),a.linesScene.remove(d),f()):b("Relationship not found")})};a.removeNode=function(h){return new Promise(function(e,f){var b=a.findNode(h);void 0!=b?(new TWEEN.Tween(b.scale)).to({x:0,y:0,z:0},500).easing(TWEEN.Easing.Linear.None).onComplete(function(){for(var f=b.children.length-1;0<=f;f--){var k=b.children[f];
k.geometry.dispose();k.material.map.dispose();k.material.dispose();b.remove(k)}b.geometry.dispose();b.material.map.dispose();b.material.dispose();a.scene.remove(b);e()}).start():f("Node not found")})};a.removeNodeWithRelationships=function(h){a.removeNode(h);for(var e=a.linesScene.children.length-1;0<=e;e--){var f=a.linesScene.children[e];"Line"!=f.type||f.startNodeId!=h&&f.endNodeId!=h||(f.geometry.dispose(),f.material.dispose(),a.linesScene.remove(f))}};a.displayCinegraphNodes=function(h,e){var f=
e&&0<h.length;if(f)for(var b=[],d=0;d<h.length;d++){var k=h[d];null!=k.start&&-1==b.indexOf(k.start)&&b.push(k.start);null!=k.end&&-1==b.indexOf(k.end)&&b.push(k.end)}e&&void 0!=a.scope.currentCinegraph.nodes&&(h=h.concat(a.scope.currentCinegraph.nodes));var c=a.getCinegraphPositions(h,e),p;for(p in c)d=a.findNode(p),void 0===d||d.IsSuggested?a.addNode(p,c[p]).then(function(e){e==Object.keys(c)[0]&&a.selectNode(e);f&&-1!==b.indexOf(parseInt(e))&&q(e)}):e&&(new TWEEN.Tween(d.position)).to({x:c[p].x,
y:c[p].y,z:c[p].z},1E3).easing(TWEEN.Easing.Linear.None).start();for(d=0;d<h.length;d++)if(k=h[d],null!=k.start&&null!=k.end){var n=a.findRelationship(k.start,k.end);void 0===n?(n=g(c[k.end],k.type,!1),n.endNodeId=k.end,n.startNodeId=k.start,a.linesScene.add(n),a.animateLine(n,c[k.start],c[k.end])):e&&a.animateLine(n,c[k.start],c[k.end])}k=new THREE.Vector3(0,0,0);if(f){for(d=0;d<b.length;d++)k.add(c[b[d]]);k.divideScalar(0<b.length?b.length:1)}else{for(p in c)k.add(c[p]);k.divideScalar(Object.keys(c).length)}a.cameraLookAtPosition(k)};
a.refreshGraph=function(){a.removeFilters();a.displayCinegraphNodes([],!0)};a.removeSuggestions=function(){};return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(b){b=b||window.event;var e=(b.target||b.srcElement).getBoundingClientRect(),d=b.clientX-e.left;b=b.clientY-e.top;f.x=d/a.viewWidth*2-1;f.y=2*-(b/a.viewHeight)+1;f.clientX=d;f.clientY=b}function l(a,b,e,f){if(e<a){var d=a;a=e;e=d;d=b;b=f;f=d}0>=$("#line").length?(d=document.createElement("div"),d.style.borderBottom="8px solid",d.style.borderColor="red",d.style.position="absolute",d.style.zIndex="99999",d.id="line",$("#graph").before(d),$("#line").mouseup(function(){$("#graph").trigger("mouseup")})):
d=$("#line")[0];var k=Math.sqrt((a-e)*(a-e)+(b-f)*(b-f));d.style.width=k+"px";-1<navigator.userAgent.indexOf("MSIE")?(d.style.top=f>b?b+"px":f+"px",d.style.left=a+"px",a=(e-a)/k,b=(f-b)/k,d.style.filter="progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+a+", M12="+-1*b+", M21="+b+", M22="+a+")"):(f=Math.atan((f-b)/(e-a)),d.style.top=b+.5*k*Math.sin(f)+"px",d.style.left=a-.5*k*(1-Math.cos(f))+"px",d.style.transform=d.style.MozTransform=d.style.WebkitTransform=d.style.msTransform=
d.style.OTransform="rotate("+f+"rad)")}function c(n){m(n);if(d)a.options.enablePathfinding&&b.onNode&&(h=e(),0<h.length&&(n=h[0].object._id,void 0!=n&&-1==$.inArray(n,b.cinegraphPath)&&b.cinegraphPath.push(n)),l(b.clientX,b.clientY,f.clientX,f.clientY));else{n=e();var h=void 0;if(0<n.length){h=n[0].object;if(h.isOverlaySprite||h.isOutlineSprite)h=h.parent;if(h===k)return;h.onHover()}if(void 0!==k&&void 0!==k.onLeave)k.onLeave();k=h}}function g(k){m(k);b.x=f.x;b.y=f.y;b.clientX=f.clientX;b.clientY=
f.clientY;b.onNode=!1;b.cinegraphPath=[];a.options.enablePathfinding?1==k.which&&(0<e().length&&(b.onNode=!0,a.cameraControls.enabled=!1),d=!0):d=!0}function q(k){m(k);d=!1;a.cameraControls.enabled=!0;if(a.options.enablePathfinding&&($("#line").remove(),b.onNode&&1<b.cinegraphPath.length)){k=a.findNode(b.cinegraphPath[0]);var c=a.findNode(b.cinegraphPath[b.cinegraphPath.length-1]);a.findCinegraphPath(k,c)}b.onNode=!1;if(f.x==b.x&&f.y==b.y)if(k=e()[0],void 0==k)a.removeSuggestions(),a.removeFilters(a.currentNode.id);
else{if(k.object.isOutlineSprite||k.object.isOverlaySprite)k.object=k.object.parent;void 0!=k.object.node?(c=k.object.node.id,a.removeFilters(a.currentNode.id),c===a.currentNode.id&&h(c),a.cameraLookAtNode(c),a.currentNode.sprite=k.object,a.selectNode(c),a.addRelatedNodes(c).then(function(b){a.removeOutOfDepthNodes()})):k.object.isChildButton&&(console.log(k.object),k.object.onClick())}}function h(b){b=a.findNode(b);var e=Math.PI/6;if(void 0!=b){var d=4;for(job in a.relationships)d++,a.addChildButton(b,
.667,e*d,.33,job,a.relationships[job].color,function(){alert(job)})}}function e(){u.setFromCamera(f,a.camera);return u.intersectObjects(a.scene.children,!0)}var f,b,d,k,u,p;a.initInput=function(){f=new THREE.Vector2;b={};d=!1;k=void 0;u=new THREE.Raycaster;$("#graph").off("mousedown").on("mousedown",g);$("#graph").off("mouseup").on("mouseup",q);$("#graph").off("mousemove").on("mousemove",c);a.cameraControls.addEventListener("change",function(){a.renderNeedsUpdate=!0});$(document).keyup(a.switchRenderMode);
window.addEventListener("resize",a.onWindowResize,!1);p=$('<div id="canvasNodeLabel" style="text-align:center;"><div class="labelText"></div></div>');p.css({position:"absolute","z-index":"1","background-color":"#aaaaaa",color:"white",padding:"10px",left:"-10000"});$("#graph").parent().css("position","relative");$("#graph").after(p)};a.destroyInput=function(){u=null;$(document).unbind("keyup",a.switchRenderMode);$("#graph").off("mousedown");$("#graph").off("mouseup");$("#graph").off("mousemove")};
a.updateHoverLabel=function(b){$("#canvasNodeLabel .labelText").text(b);a.updateHoverLabelPosition()};a.updateHoverLabelPosition=function(){if(void 0!==k){var b=a.toScreenPosition(k.position),e=a.getSpriteRadius(k.position,k.scale.x),d=b.y-e-$("#canvasNodeLabel").outerHeight();0>d&&(d=b.y+e);$("#canvasNodeLabel").css({top:d,left:b.x-$("#canvasNodeLabel").outerWidth()/2})}};a.addChildButton=function(b,e,d,f,k,h,c){var g=a.getButtonSprite(k,h);g.scale.set(0,0,0);g.position.set(Math.cos(d)*e,Math.sin(d)*
e,0);g.onClick=c;g.onHover=function(){$("#graph").css({cursor:"pointer"});(new TWEEN.Tween(g.children[0].material)).to({opacity:1},300).easing(TWEEN.Easing.Linear.None).start()};g.onLeave=function(){$("#graph").css({cursor:"default"});(new TWEEN.Tween(g.children[0].material)).to({opacity:0},300).easing(TWEEN.Easing.Linear.None).start()};b.add(g);a.animateNodeScale(g,f,250,0)};a.removeFilters=function(b){var e=a.findNode(b);if(void 0!==e)for(b=e.children.length-1;0<=b;b--){var d=e.children[b];d.isChildButton&&
function(a){(new TWEEN.Tween(a.scale)).to({x:0,y:0,z:0},180).easing(TWEEN.Easing.Linear.None).onComplete(function(){a.geometry.dispose();a.material.dispose();e.remove(a)}).start()}(d)}};THREE.Sprite.prototype.raycast=function(){var a=new THREE.Vector3;return function(b,e){a.setFromMatrixPosition(this.matrixWorld);var d=b.ray.distanceSqToPoint(a),f=this.scale.x*this.scale.y;8==this.scale.x?f=14:.33==this.scale.x?f=1.63:.23==this.scale.x&&(f=.8);d>f||e.push({distance:Math.sqrt(d),point:this.position,
face:null,object:this})}}();return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(l){for(var c=0;c<l.length;c++){for(var g=l[c],q=!0,h=!0,e=!0,f=0;f<a.scope.currentCinegraph.nodes.length;f++){var b=a.scope.currentCinegraph.nodes[f];g.start==b.start&&g.end==b.end&&(q=!1);if(g.start==b.start||g.start==b.end)h=!1;if(g.end==b.start||g.end==b.end)e=!1}q&&a.removeRelationship(g.start,g.end);h&&a.removeNode(g.start);e&&a.removeNode(g.end)}}a.findCinegraphPath=function(l,c){if(void 0!=l&&void 0!=c){var g=$('<div id="canvasPathPanel"><h3 class="inline">Searching for paths...</h3></div>');
$("#graph").after(g.hide().slideDown(500));$http.get("/api/mycinegraph/path/"+l._id+"/"+c._id).success(function(c){for(var h=0;h<c.length;h++)for(var e=c[h],f=0;f<e.length;f++)e[f]=JSON.parse(e[f]);g.paths=c;g.current=0;g.find("h3").text("Path 1 of "+c.length+":");a.displayCinegraphNodes(g.paths[g.current],!0);g.append('<a href="#" class="btn btn-s-md btn-success canvasPathPanelAdd m-l m-t v-top">Add</a>\r\n                <a href="#" class="btn btn-s-md btn-default canvasPathPanelPrevious m-t v-top">Previous</a>\r\n                <a href="#" class="btn btn-s-md btn-default canvasPathPanelNext m-t v-top">Next</a>\r\n                <a href="#" class="btn btn-s-md btn-default canvasPathPanelCancel m-t v-top">Cancel</a>');
$(".canvasPathPanelCancel").click(function(){$("#canvasPathPanel").slideUp().remove();m(g.paths[g.current])});$(".canvasPathPanelNext").click(function(){g.current<g.paths.length-1&&(m(g.paths[g.current]),g.current++,g.find("h3").text("Path "+(g.current+1)+" of "+c.length+":"),a.displayCinegraphNodes(g.paths[g.current],!0))});$(".canvasPathPanelPrevious").click(function(){0<g.current&&(m(g.paths[g.current]),g.current--,g.find("h3").text("Path "+(g.current+1)+" of "+c.length+":"),a.displayCinegraphNodes(g.paths[g.current],
!0))});$(".canvasPathPanelAdd").click(function(){for(var b=g.paths[g.current],e=0;e<b.length;e++){for(var f=b[e],h=!0,c=0;c<a.scope.currentCinegraph.nodes.length;c++){var n=scope.currentCinegraph.nodes[c];if(f.start==n.start&&f.end==n.end){h=!1;break}}h&&scope.currentCinegraph.nodes.push(f)}for(e=scope.currentCinegraph.nodes.length-1;0<=e;e--)if(f=scope.currentCinegraph.nodes[e],null==f.start||null==f.end)for(b=null!=f.start?f.start:f.end,c=0;c<scope.currentCinegraph.nodes.length;c++)if(c!=e&&(n=
scope.currentCinegraph.nodes[c],n.start==b||n.end==b)){scope.currentCinegraph.nodes.splice(e,1);break}$http.put("/api/mycinegraph/"+scope.currentCinegraph.id,{titleCinegraph:scope.currentCinegraph.title,cinegraphNodes:JSON.stringify(scope.currentCinegraph.nodes)});$("#canvasPathPanel").slideUp(500).remove()})})}};return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(a,g){var l;for(l=0;l<a.length;++l)if(200>=a[l].distanceToSquared(g))return!1;return!0}function l(c,g,l,h){var e=c.start;c=c.end;if(null!=e&&void 0==g[e]){var f=void 0!=g[c]?g[c]:new THREE.Vector3(0,0,0),b=a.findNode(e);g[e]=void 0==b||h?a.getNextPosition(l,f):b.position;l.push(g[e])}null!=c&&void 0==g[c]&&(f=void 0!=g[e]?g[e]:new THREE.Vector3(0,0,0),b=a.findNode(c),g[c]=void 0==b||h?a.getNextPosition(l,f):b.position,l.push(g[c]))}a.getNewPosition=function(){return a.getNextPosition(a.getOccupiedPositions(),
new THREE.Vector3(0,0,0))};a.getOccupiedPositions=function(){for(var c=[],g=a.scene.children.length-1;0<=g;g--)"Sprite"==a.scene.children[g].type&&c.push(a.scene.children[g].position);for(g=TWEEN.getAll().length-1;0<=g;g--){var l=TWEEN.getAll()[g].getValuesEnd();void 0!=l.x&&void 0!=l.y&&void 0!=l.z&&c.push(new THREE.Vector3(l.x,l.y,l.z))}return c};a.getNextPosition=function(a,g){for(var l=18,h=g.clone(),e=0;!m(a,h);)h.x=2*Math.random()-1,h.y=2*Math.random()-1,h.z=2*Math.random()-1,h.setLength(l).round().add(g),
e++,0==e%50&&(l=18*(1+e/50));return h};a.getCinegraphPositions=function(c,g){positions=[];for(var m=1==g?[]:a.getOccupiedPositions(),h=0;h<c.length;h++){l(c[h],positions,m,g);for(var e=c[h].start,f=c[h].end,b=h+1;b<c.length;b++)c[b].start!=e&&c[b].end!=e||l(c[b],positions,m,g);for(b=h+1;b<c.length;b++)c[b].start!=f&&c[b].end!=f||l(c[b],positions,m,g)}return positions};return a}(CINEGRAPH||{});CINEGRAPH=function(a){var m,l,c,g,q,h,e,f,b,d,k,u;a.renderNeedsUpdate=!1;a.initRender=function(){d=e=h=q=0;k=1;u=0;a.renderNeedsUpdate=!1;m=new THREE.WebGLRenderer({antialias:!1,alpha:!0,autoClear:!1});m.setSize(a.viewWidth,a.viewHeight);document.getElementById("graph").appendChild(m.domElement);var p={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},n=new THREE.WebGLRenderTarget(1*a.viewWidth,1*a.viewHeight,p),t=new THREE.RenderPass(a.linesScene,
a.camera),r=new THREE.ShaderPass(THREE.ThickLineShader);r.uniforms.totalWidth.value=1*a.viewWidth;r.uniforms.totalHeight.value=1*a.viewHeight;r.uniforms.edgeWidth.value=6;l=new THREE.EffectComposer(m,n);l.addPass(t);l.addPass(r);p=new THREE.WebGLRenderTarget(1*a.viewWidth,1*a.viewHeight,p);n=new THREE.RenderPass(a.scene,a.camera);t=new THREE.ShaderPass(THREE.CopyShader);c=new THREE.EffectComposer(m,p);c.addPass(n);c.addPass(t);p=new THREE.ShaderPass(THREE.BlendShader);p.uniforms.tBase.value=l.renderTarget1;
p.uniforms.tAdd.value=c.renderTarget1;p.renderToScreen=!0;g=new THREE.EffectComposer(m);g.addPass(p);b=new THREEx.RendererStats;b.domElement.style.position="absolute";b.domElement.style.right="0px";b.domElement.style.bottom="0px";b.domElement.style.display="none";b.domElement.id="rendererStats";f=new Stats;f.setMode(0);f.domElement.style.position="absolute";f.domElement.style.right="80px";f.domElement.style.bottom="0px";f.domElement.style.display="none";document.body.appendChild(b.domElement);document.body.appendChild(f.domElement)};
a.destroyRender=function(){cancelAnimationFrame(e);a.scene=null;a.linesScene=null;a.cameraControls=null;document.body.removeChild(f.domElement);document.body.removeChild(b.domElement);b=f=null};a.animate=function(){e=requestAnimationFrame(a.animate);f.begin();b.update(m);var d=(new Date).getTime();TWEEN.update();a.cameraControls.update();var n=u;u=TWEEN.getAll().length;if(a.renderNeedsUpdate||0<u||0<n&&0==u){for(n=0;n<a.scene.children.length;n++){var t=a.scene.children[n];"Sprite"==t.type&&(t.lookAt(a.camera.position),
t.quaternion.copy(a.camera.quaternion))}m.clear();l.render();a.updateHoverLabelPosition(a.currentNode);a.updateGradientLayer();c.render();g.render();a.renderNeedsUpdate=!1;n=(new Date).getTime();120>h?(h++,q+=n-d):(d=q/120,33.33<d&&.5<k?(k=Math.max(.5,.75*k),a.onWindowResize()):20>d&&1>k&&(k=Math.min(1,1.25*k),a.onWindowResize()),h=q=0)}f.end()};a.onWindowResize=function(){a.viewWidth=$("#graph").find("canvas").width(0).parent().width();a.viewHeight=$("#graph").find("canvas").height(0).parent().height();
a.camera.aspect=a.viewWidth/a.viewHeight;a.camera.updateProjectionMatrix();m.setSize(a.viewWidth,a.viewHeight);var b=1*a.viewWidth*k,e=1*a.viewHeight*k;l.setSize(b,e);var f=l.passes[1];f.uniforms.totalWidth.value=b;f.uniforms.totalHeight.value=e;f.uniforms.edgeWidth.value=6*k;c.setSize(b,e);g.setSize(b/1,e/1);b=g.passes[0];b.uniforms.tBase.value=l.renderTarget1;b.uniforms.tAdd.value=c.renderTarget1;a.renderNeedsUpdate=!0};a.switchRenderMode=function(b){switch(b.which){case 112:d=(d+1)%3;l.passes[l.passes.length-
1].renderToScreen=1==d;c.passes[c.passes.length-1].renderToScreen=2==d;g.passes[g.passes.length-1].renderToScreen=0==d;a.renderNeedsUpdate=!0;break;case 113:$("#stats, #rendererStats").toggle();break;default:return}b.preventDefault()};return a}(CINEGRAPH||{});CINEGRAPH=function(a){function m(a,f,b,d,k,h){if(-1==f.indexOf(" "))a.fillText(f,b,d,k);else{f=f.split(" ");for(var c="",g=0,l=0;l<f.length;l++){var m=c+f[l]+" ";if(a.measureText(m).width>k&&0<l){g++;if(3==g){a.fillText(c.slice(0,-1)+"...",b,d,k);return}a.fillText(c,b,d,k);c=f[l]+" ";d+=h}else c=m}a.fillText(c,b,d,k)}}function l(a,f,b){var d=document.createElement("canvas");d.width=256;d.height=256;var k=d.width/2,c=d.height/2,g=d.getContext("2d");g.beginPath();g.arc(k,c,k,0,h);g.clip();g.fillStyle=
f;g.fillRect(0,0,d.width,d.height);g.fillStyle=b;g.font="bold 100px Arial";g.textAlign="center";g.textBaseline="middle";g.fillText(a.toUpperCase().substring(0,2),k,k);return d}function c(a,f,b,d,k,h,c,g){2===arguments.length&&(b=d=0,k=a.canvas.width,h=a.canvas.height);c="number"===typeof c?c:.5;g="number"===typeof g?g:.5;0>c&&(c=0);0>g&&(g=0);1<c&&(c=1);1<g&&(g=1);var l=f.width,m=f.height,q=Math.min(k/l,h/m),w=Math.round(l*q),q=Math.round(m*q),v,x;v=1;w<k&&(v=k/w);q<h&&(v=h/q);w=l/(w*v/k);x=m/(q*
v/h);q=(l-w)*c;v=(m-x)*g;0>q&&(q=0);0>v&&(v=0);w>l&&(w=l);x>m&&(x=m);a.drawImage(f,q,v,w,x,b,d,k,h)}var g,q,h=2*Math.PI;a.initTexture=function(){g=new Image;g.src="images/default_bg2.jpg";q=[]};a.getDefaultImage=function(){return g};a.getNodeOpacity=function(){return.6};a.updateGradientLayer=function(){for(var e=0;e<a.scene.children.length;e++){var f=a.scene.children[e],b=a.getSpriteRadius(f.position,f.scale.x);if(!(2>=b)){var d=a.toScreenPosition(f.position);if(!(0>d.x+b||d.x-b>a.viewWidth||0>d.y+
b||d.y-b>a.viewHeight)){for(var k=0;k<f.children.length;k++)f.children[k].gradientIsActive=!1;for(b=a.linesScene.children.length-1;0<=b;b--)if(d=a.linesScene.children[b],"Line"==d.type){var c;if(d.endNodeId==f._id)c=0;else if(d.startNodeId==f._id)c=1;else continue;var g=0==c?1:0;if(!(16>=d.geometry.vertices[c].distanceToSquared(d.geometry.vertices[g]))){var l="#"+d.geometry.colors[c].getHexString();if(l!==f.node._color){c=a.toScreenPosition(d.geometry.vertices[c]);for(var m=a.toScreenPosition(d.geometry.vertices[g]),
d=d.startNodeId+","+d.endNodeId,g=!1,k=0;k<f.children.length;k++){var r=f.children[k];if(r.lineId==d){g=!0;c=m.sub(c);m=(new THREE.Vector3(1,0,0)).angleTo(c);r.material.rotation=0<c.y?-m:m;r.gradientIsActive=!0;break}}g||(void 0==q[l]&&(c=new THREE.Color(l),g=document.createElement("canvas"),g.width=256,g.height=256,r=g.width/2,m=g.getContext("2d"),m.beginPath(),m.arc(r,r,r,0,h),m.clip(),m.fillStyle="rgba("+255*c.r+","+255*c.g+","+255*c.b+",0)",m.fill(),m.shadowOffsetX=1E3,m.shadowOffsetY=1E3,m.shadowBlur=
r/2.5,m.fillStyle=l,m.shadowColor=l,m.beginPath(),m.arc(2*r-m.shadowOffsetX,r-m.shadowOffsetY,r-1.2*m.shadowBlur,0,h,!0),m.fill(),q[l]=g),l=new THREE.Texture(q[l]),c=new THREE.SpriteMaterial({map:l,transparent:!0}),c=new THREE.Sprite(c),l.needsUpdate=!0,r=c,r.lineId=d,f.add(r),r.gradientIsActive=!0)}}}for(k=0;k<f.children.length;k++)r=f.children[k],r.gradientRemoveDisable||r.gradientIsActive||(r.geometry.dispose(),r.material.dispose(),f.remove(r))}}}};a.getNodeSprite=function(e){var f=e.name?e.firstname+
" "+e.lastname:e.title,b=a.generateTexture(void 0!=e.jobs?e.jobs[0].name:void 0,a.getDefaultImage(),f),d=new THREE.Texture(b);d.minFilter=THREE.LinearFilter;d.needsUpdate=!0;var c=new THREE.Sprite(new THREE.SpriteMaterial({map:d}));c._id=e.id;c.name=f;c.canvas=b;c.texture=d;c.mainJob=Object.keys(e._relationships)[0];c.node=e;void 0==e.img||0==e.img?c.nodeImage=a.getDefaultImage():(c.nodeImage=new Image,c.nodeImage.src=void 0==e.title?"images/persons/"+a.sanitizeFileName(e.fullname)+".jpg":"images/movies/"+
a.sanitizeFileName(e.title+e.released)+"/poster.jpg",c.nodeImage.onerror=function(){this.src="images/default.jpg"},c.nodeImage.onload=function(){a.updateTexture(c.mainJob,c.nodeImage,c.canvas,c.name);c.texture.needsUpdate=!0});e=a.generateSpriteBackground(c);e.material.depthTest=!1;e.isOutlineSprite=!0;e.position.set(0,0,-1E-6);c.add(e);var g=a.generateSpriteOverlay(f,c.node._color);g.material.depthTest=!1;g.isOverlaySprite=!0;g.position.set(0,0,1E-4);c.add(g);c.onHover=function(){$("#graph").css({cursor:"pointer"});
g.onHover();a.updateHoverLabel(this.name)};c.onLeave=function(){$("#graph").css({cursor:"default"});g.onLeave()};return c};a.generateSpriteBackground=function(a){var c=document.createElement("canvas");c.width=256;c.height=256;var b=c.getContext("2d");b.beginPath();var d=c.width/2;b.arc(d,d,d,0,h);b.clip();b.fillStyle=a.node._color;b.fillRect(0,0,c.width,c.height);c=new THREE.Texture(c);a=new THREE.SpriteMaterial({map:c});a=new THREE.Sprite(a);a.gradientRemoveDisable=!0;c.needsUpdate=!0;return a};
a.generateSpriteOverlay=function(a,c){var b=document.createElement("canvas");b.width=256;b.height=256;var d=b.width/24,g=b.width/2,l=b.height/2,p=b.getContext("2d");p.beginPath();p.arc(g,l,g-d,0,h);p.clip();p.fillStyle="#000000";p.fillRect(0,0,b.width,b.height);p.fillStyle="#ffffff";p.font="bold "+b.width/9+"px Arial";p.textAlign="center";m(p,a.toUpperCase(),g,b.height/2.5,b.width-5*d,b.height/6);b=new THREE.Texture(b);d=new THREE.SpriteMaterial({map:b,transparent:!0,opacity:.6});d=new THREE.Sprite(d);
d.gradientRemoveDisable=!0;b.needsUpdate=!0;d.onHover=function(){(new TWEEN.Tween(this.material)).to({opacity:0},300).easing(TWEEN.Easing.Linear.None).start()};d.onLeave=function(){(new TWEEN.Tween(this.material)).to({opacity:.6},300).easing(TWEEN.Easing.Linear.None).start()};return d};a.generateTexture=function(c,f,b){var d=document.createElement("canvas");d.width=256;d.height=256;a.updateTexture(c,f,d,b,.6);return d};a.updateTexture=function(a,f,b,d,g){a=b.width/24;d=b.width/2;g=b.height/2;var l=
b.getContext("2d");l.beginPath();l.arc(d,g,d-a,0,h);l.clip();c(l,f,a,a,b.width-2*a,b.height-2*a)};a.getButtonSprite=function(a,c){var b=new THREE.SpriteMaterial({map:new THREE.Texture(l(a,"#222222",c))}),b=new THREE.Sprite(b);b.material.map.needsUpdate=!0;b.material.depthTest=!1;b.isChildButton=!0;b.gradientRemoveDisable=!0;var d=new THREE.SpriteMaterial({map:new THREE.Texture(l(a,c,"#222222"))}),d=new THREE.Sprite(d);d.material.depthTest=!1;d.material.opacity=0;d.material.map.needsUpdate=!0;d.isOverlaySprite=
!0;d.position.set(0,0,1E-4);b.add(d);return b};a.sanitizeFileName=function(a){return void 0==a?a:a.replace(RegExp('[,/:*?""<>|]',"g"),"_")};a.updateBackground=function(c){var f=$("#graph").find(".canvasBackground"),b=$('<div class="canvasBackground"></div>');$("#graph").find("canvas").before(b);if(void 0==c.img||0==c.img)b.css("opacity"),b.css({"background-image":'url("'+g.src+'")',opacity:1,top:0<f.length?"-100%":"0"}),setTimeout(function(){f.remove();b.css("top","0")},1E3);else{var d=new Image;
d.src=void 0==c.title?"images/persons/"+a.sanitizeFileName(c.fullname)+".jpg":"images/movies/"+a.sanitizeFileName(c.title+c.released)+"/backdrop.jpg";d.onerror=function(){this.src="images/movies/"+a.sanitizeFileName(c.title+c.released)+"/poster.jpg";d.onerror=function(){this.src="images/default.jpg"}};d.onload=function(){b.css({"background-image":'url("'+d.src+'")',opacity:1,top:0<f.length?"-100%":"0"});setTimeout(function(){f.remove();b.css("top","0")},1E3)}}};return a}(CINEGRAPH||{});
